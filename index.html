<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Levelized Cost of Hydrogen (LCOH) Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      text-align: center;
    }
    h1 {
      color: #006400;
    }
    .input-group {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      text-align: left;
    }
    label {
      flex: 1;
      padding-right: 10px;
      min-width: 180px;
    }
    input {
      flex: 1;
      padding: 5px;
    }
    button {
      background-color: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      margin: 10px 5px;
      font-weight: bold;
      border-radius: 4px;
    }
    button:hover {
      background-color: #218838;
    }
    .result {
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 20px;
      text-align: left;
      white-space: pre-line;
      font-family: monospace;
      min-height: 100px;
    }
    canvas {
      max-width: 70%;
      margin-top: 30px;
    }
    .top-controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
    }
    select {
      padding: 5px;
      font-weight: bold;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Levelized Cost of Hydrogen (LCOH)</h1>

  <div class="top-controls">
    <div>
      <label for="currency">Currency:</label>
      <select id="currency" onchange="convertCurrencyAndUnits()">
        <option value="INR" selected>INR (₹)</option>
        <option value="EUR">EUR (€)</option>
        <option value="USD">USD ($)</option>
      </select>
    </div>
    <button onclick="updateExchangeRates()">Update Exchange Rates</button>
  </div>

  <form id="lcohForm">
    <h2>Step 1: System and Cost Inputs</h2>
    <div class="input-group">
      <label for="capex">CAPEX Electrolyzer (<span class="unit" data-currency="true">₹</span>/kW):</label>
      <input type="number" id="capex" value="72000" step="any" required />
    </div>
    <div class="input-group">
      <label for="stackReplacement">Stack Replacement Cost (% of CAPEX):</label>
      <input type="number" id="stackReplacement" value="15" step="any" required />
    </div>
    <div class="input-group">
      <label for="replacementFrequency">Replacement Frequency (years):</label>
      <input type="number" id="replacementFrequency" value="7" step="any" required />
    </div>
    <div class="input-group">
      <label for="pressure">Pressure (bar):</label>
      <input type="number" id="pressure" value="30" step="any" required />
    </div>
    <div class="input-group">
      <label for="electrolyzerPower">Electrolyzer Power (kW):</label>
      <input type="number" id="electrolyzerPower" value="1000" step="any" required />
    </div>
    <div class="input-group">
      <label for="bopLosses">BoP Losses (%):</label>
      <input type="number" id="bopLosses" value="5" step="any" required />
    </div>

    <h2>Step 2: Operation and Energy Inputs</h2>
    <div class="input-group">
      <label for="electricity">Electricity Price (<span class="unit" data-currency="true">₹</span>/MWh):</label>
      <input type="number" id="electricity" value="6300" step="any" required />
    </div>
    <div class="input-group">
      <label for="efficiency">Efficiency (%):</label>
      <input type="number" id="efficiency" value="80" step="any" required />
    </div>
    <div class="input-group">
      <label for="fullLoad">Full Load Hours (hours/year):</label>
      <input type="number" id="fullLoad" value="4000" step="any" required />
    </div>
    <div class="input-group">
      <label for="lifetime">System Lifetime (years):</label>
      <input type="number" id="lifetime" value="20" step="any" required />
    </div>
    <div class="input-group">
      <label for="discountRate">Discount Rate (%):</label>
      <input type="number" id="discountRate" value="7" step="any" required />
    </div>

    <h2>Step 3: Revenue and Water Inputs</h2>
    <div class="input-group">
      <label for="o2Revenue">O₂ Sale Revenue (<span class="unit" data-currency="true">₹</span>/kg H₂):</label>
      <input type="number" id="o2Revenue" value="45" step="any" required />
    </div>
    <div class="input-group">
      <label for="waterCost">Water Cost (<span class="unit" data-currency="true">₹</span>/m³):</label>
      <input type="number" id="waterCost" value="180" step="any" required />
    </div>
    <div class="input-group">
      <label for="waterConsumption">Water Consumption (L/kg H₂):</label>
      <input type="number" id="waterConsumption" value="10" step="any" required />
    </div>

    <h2>Step 4: Financial Assumptions</h2>
    <div class="input-group">
      <label for="co2Price">CO₂ Credit (<span class="unit" data-currency="true">₹</span>/kg H₂):</label>
      <input type="number" id="co2Price" value="0" step="any" required />
    </div>
    <div class="input-group">
      <label for="additionalRevenue">Other Revenue (<span class="unit" data-currency="true">₹</span>/kg H₂):</label>
      <input type="number" id="additionalRevenue" value="0" step="any" required />
    </div>

    <button type="submit">Calculate LCOH</button>
    <button type="button" onclick="downloadCSV()">Download CSV</button>
  </form>

  <div class="result" id="output"></div>
  <canvas id="lcohChart"></canvas>

  <script>
    // Exchange rates relative to INR base
    const exchangeRates = {
      INR: 1,
      USD: 0.012,
      EUR: 0.011
    };

    const currencySymbols = {
      INR: '₹',
      USD: '$',
      EUR: '€'
    };

    async function updateExchangeRates() {
      try {
        const res = await fetch('https://api.exchangerate.host/latest?base=INR&symbols=USD,EUR');
        const data = await res.json();
        exchangeRates.USD = data.rates.USD;
        exchangeRates.EUR = data.rates.EUR;
        alert(`Updated exchange rates:\n1 INR = ${exchangeRates.USD.toFixed(4)} USD\n1 INR = ${exchangeRates.EUR.toFixed(4)} EUR`);
      } catch {
        alert("Failed to fetch live exchange rates. Using default rates.");
      }
    }

    function convertCurrencyAndUnits() {
      const currency = document.getElementById('currency').value;
      const symbol = currencySymbols[currency];
      const factor = exchangeRates[currency];

      // Update all currency unit symbols
      document.querySelectorAll('.unit[data-currency="true"]').forEach(el => {
        el.textContent = symbol;
      });

      // Convert all currency input values accordingly
      // To preserve original logic, convert values back to INR base first, then to selected currency
      // We must only convert fields related to currency (e.g. costs), NOT pure physical units
      const currencyFieldIds = [
        'capex', 'electricity', 'o2Revenue', 'waterCost', 'co2Price', 'additionalRevenue'
      ];

      currencyFieldIds.forEach(id => {
        const input = document.getElementById(id);
        if (!input) return;
        let val = parseFloat(input.getAttribute('data-original'));
        if (!val) {
          // If no data-original attr, set it from current value assuming base currency INR
          val = parseFloat(input.value);
          input.setAttribute('data-original', val);
        }
        // Convert original INR value to current currency
        input.value = (val * factor).toFixed(2);
      });
    }

    function resetOriginalValues() {
      // Store original INR values on all currency inputs on page load or form reset
      const currencyFieldIds = [
        'capex', 'electricity', 'o2Revenue', 'waterCost', 'co2Price', 'additionalRevenue'
      ];
      currencyFieldIds.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.setAttribute('data-original', parseFloat(input.value));
        }
      });
    }

    function downloadCSV() {
      const output = document.getElementById('output').innerText.trim();
      if (!output) {
        alert("Please calculate first to generate CSV.");
        return;
      }
      const lines = output.split('\n');
      const csvContent = lines.map(line => line.replace(/\s+/g, ',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "LCOH_results.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Main calculation function
    function calculateLCOH(e) {
      e.preventDefault();

      const currency = document.getElementById('currency').value;
      const factor = exchangeRates[currency];
      const symbol = currencySymbols[currency];

      // Read inputs, convert all currency inputs back to INR base for calculation
      // We'll keep calculations in INR internally, then convert results back to selected currency

      function getVal(id) {
        const el = document.getElementById(id);
        if (!el) return 0;
        if (['capex','electricity','o2Revenue','waterCost','co2Price','additionalRevenue'].includes(id)) {
          // Convert displayed currency value back to INR
          let displayed = parseFloat(el.value);
          if (isNaN(displayed)) displayed = 0;
          const valINR = displayed / factor; // displayed currency to INR
          return valINR;
        } else {
          const val = parseFloat(el.value);
          return isNaN(val) ? 0 : val;
        }
      }

      // Input vars
      const capex = getVal('capex'); // ₹/kW
      const stackReplacementPct = getVal('stackReplacement') / 100; // fraction
      const replacementFreq = getVal('replacementFrequency'); // years
      const pressure = getVal('pressure'); // bar (no currency)
      const electrolyzerPower = getVal('electrolyzerPower'); // kW
      const bopLossesPct = getVal('bopLosses') / 100; // fraction

      const electricityPrice = getVal('electricity'); // ₹/MWh
      const efficiency = getVal('efficiency') / 100; // fraction
      const fullLoadHours = getVal('fullLoad'); // hours/year
      const lifetime = getVal('lifetime'); // years
      const discountRate = getVal('discountRate') / 100; // fraction

      const o2Revenue = getVal('o2Revenue'); // ₹/kg H2
      const waterCost = getVal('waterCost'); // ₹/m3
      const waterConsumption = getVal('waterConsumption') / 1000; // convert L/kg to m3/kg

      const co2Price = getVal('co2Price'); // ₹/kg H2
      const additionalRevenue = getVal('additionalRevenue'); // ₹/kg H2

      // Derived calculations
      // CAPEX total including stack replacements
      const stackReplacementCost = capex * stackReplacementPct * electrolyzerPower;

      // Annual CAPEX annuity factor
      function annuityFactor(rate, n) {
        return (rate * Math.pow(1 + rate, n)) / (Math.pow(1 + rate, n) - 1);
      }

      const capexTotal = capex * electrolyzerPower;
      const capexAnnuity = capexTotal * annuityFactor(discountRate, lifetime);

      // Calculate stack replacement costs annuitized over replacement frequency
      const nReplacements = Math.floor(lifetime / replacementFreq);
      let replacementAnnuity = 0;
      for(let i = 1; i <= nReplacements; i++) {
        replacementAnnuity += stackReplacementCost / Math.pow(1 + discountRate, i * replacementFreq);
      }
      replacementAnnuity *= discountRate / (1 - Math.pow(1 + discountRate, -lifetime));

      // Electricity consumption (kWh/kg H2)
      // Theoretical electricity = 39.4 kWh/kg H2 (based on HHV)
      const theoreticalKWhPerKg = 39.4;
      const actualKWhPerKg = theoreticalKWhPerKg / efficiency;

      // Total hydrogen produced annually (kg)
      // Power * hours * (1 - BoP losses) / actual electricity per kg
      const netPower = electrolyzerPower * (1 - bopLossesPct);
      const annualH2Production = netPower * fullLoadHours / actualKWhPerKg;

      // Annual electricity cost
      const annualElectricityCost = electricityPrice * netPower * fullLoadHours / 1000; // convert MWh to kWh

      // Water cost per year
      const annualWaterCost = waterCost * waterConsumption * annualH2Production;

      // Annual O2 revenue
      const annualO2Revenue = o2Revenue * annualH2Production;

      // Annual CO2 credit + additional revenue
      const annualOtherRevenue = (co2Price + additionalRevenue) * annualH2Production;

      // Total annualized cost
      const annualCost = capexAnnuity + replacementAnnuity + annualElectricityCost + annualWaterCost - annualO2Revenue - annualOtherRevenue;

      // LCOH = Annual cost / annual hydrogen produced
      const lcohINR = annualCost / annualH2Production;

      // Convert results back to selected currency
      const lcoh = lcohINR * factor;

      // Output formatted
      const outputDiv = document.getElementById('output');
      outputDiv.innerText = 
`Levelized Cost of Hydrogen (LCOH): ${symbol} ${lcoh.toFixed(2)} per kg H₂

--- Detailed Breakdown ---
CAPEX Electrolyzer Total: ₹ ${(capexTotal).toFixed(0)}
Stack Replacement Cost (Total): ₹ ${(stackReplacementCost * nReplacements).toFixed(0)}
CAPEX Annuity: ₹ ${capexAnnuity.toFixed(0)}
Replacement Annuity: ₹ ${replacementAnnuity.toFixed(0)}
Annual Electricity Cost: ₹ ${annualElectricityCost.toFixed(0)}
Annual Water Cost: ₹ ${annualWaterCost.toFixed(0)}
Annual O₂ Revenue: ₹ ${annualO2Revenue.toFixed(0)}
Annual CO₂ & Other Revenue: ₹ ${(annualOtherRevenue).toFixed(0)}
Annual H₂ Production: ${annualH2Production.toFixed(0)} kg`;

      renderChart(lcoh);
    }

    let chartInstance = null;
    function renderChart(lcoh) {
      const ctx = document.getElementById('lcohChart').getContext('2d');
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['LCOH'],
          datasets: [{
            label: '₹ per kg H₂',
            data: [lcoh],
            backgroundColor: ['#28a745']
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    // Initialize
    window.onload = () => {
      resetOriginalValues();
      document.getElementById('lcohForm').addEventListener('submit', calculateLCOH);
    };
  </script>
</body>
</html>
